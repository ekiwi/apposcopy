/*
 * Copyright (C) 2017 The Apposcopy and Astroid Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.apposcopy.analyses;


import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import shord.project.ClassicProject;
import shord.project.analyses.JavaAnalysis;
import shord.project.analyses.ProgramRel;
import soot.SootMethod;
import chord.bddbddb.Rel.RelView;
import chord.project.Chord;
import chord.project.Config;
import chord.util.tuple.object.Pair;
import chord.util.tuple.object.Quad;

import com.apposcopy.model.Sample;
import com.google.gson.Gson;


/**
  * Given an app, deciding its family.
  * @author Yu Feng
  **/

@Chord(name="apposcopy-java")

public class Malware extends JavaAnalysis
{

    protected String belongTo;

    protected String id;

    /* Activity components */
    protected List<String> activities = new ArrayList<>();

    /* Service components */
    protected List<String> services  = new ArrayList<>();

    /* Receiver components */
    protected List<String> receivers  = new ArrayList<>();

    protected List<Pair<String, String>> iccg  = new ArrayList<>();

    protected List<Pair<String, String>> intentFilters  = new ArrayList<>();

    protected List<Pair<String, String>> dangerAPIs  = new ArrayList<>();

    protected List<Quad<String, String, String, String>> taintFlows  = new ArrayList<>();

	public void run() {
        String malStr = "";
        malStr = malStr.replaceAll("\\s+","");
        System.out.println("-----------Malware family=: " + malStr);
        //store family name
        belongTo = malStr;

        dumpJson();
	}


    public void dumpJson() {
        System.out.println("Begin to output Json file: ");
        //Activity
        ProgramRel relAct = (ProgramRel) ClassicProject.g().getTrgt("Activity");
        relAct.load();
        RelView viewAct = relAct.getView();
        Iterable<String> resAct = viewAct.getAry1ValTuples();
        for (String comp : resAct) {
            activities.add(comp);
        }
        //Service
        ProgramRel relServ = (ProgramRel) ClassicProject.g().getTrgt("Service");
        relServ.load();
        RelView viewServ = relServ.getView();
        Iterable<String> resServ = viewServ.getAry1ValTuples();
        for (String comp : resServ) {
            services.add(comp);
        }
        //Receiver
        ProgramRel relRecv = (ProgramRel) ClassicProject.g().getTrgt("Receiver");
        relRecv.load();
        RelView viewRecv = relRecv.getView();
        Iterable<String> resRecv = viewRecv.getAry1ValTuples();
        for (String comp : resRecv) {
            receivers.add(comp);
        }
        //ICCG
        ProgramRel relICCG = (ProgramRel) ClassicProject.g().getTrgt("ICCG");
        relICCG.load();
        RelView viewICCG = relICCG.getView();
        Iterable<Pair<String, String>> resICCG = viewICCG.getAry2ValTuples();
        for (Pair<String, String> edge : resICCG) {
            iccg.add(edge);
        }

        //Dangerous APIs
        ProgramRel relSpecCall = (ProgramRel) ClassicProject.g().getTrgt("SpecCallerComp");
        relSpecCall.load();
        RelView viewSpecCall = relSpecCall.getView();
        Iterable<Pair<SootMethod, String>> resSpecCall = viewSpecCall
                .getAry2ValTuples();
        for (Pair<SootMethod, String> spec : resSpecCall) {
            String methSig = spec.val0.getSignature();
            Pair<String, String> specPair = new Pair<String, String>(spec.val1, methSig);
            dangerAPIs.add(specPair);
        }

        //Intent Filters
        ProgramRel relCIA = (ProgramRel) ClassicProject.g().getTrgt("CompIntentAction");
        relCIA.load();
        RelView viewCIA = relCIA.getView();
        Iterable<Pair<String, String>> resCIA = viewCIA.getAry2ValTuples();
        for (Pair<String, String> intentFilter : resCIA) {
            intentFilters.add(intentFilter);
        }
        //Taint flows
        ProgramRel relFlowComp = (ProgramRel) ClassicProject.g().getTrgt("SrcSinkComp");
        relFlowComp.load();
        RelView viewFlowComp = relFlowComp.getView();
        Iterable<Quad<String, String, String, String>> resFlowComp = viewFlowComp
                .getAry4ValTuples();
        for (Quad<String, String, String, String> taint : resFlowComp) {
            taintFlows.add(taint);
        }

        // dump to json.
        Sample sam = new Sample();
        sam.setFamily(belongTo);
        sam.setActivities(activities);
        sam.setServices(services);
        sam.setReceivers(receivers);
        sam.setIccg(iccg);
        sam.setIntentFilters(intentFilters);
        sam.setDangerAPIs(dangerAPIs);
        sam.setTaintFlows(taintFlows);
        if(taintFlows.isEmpty()) {
            System.out.println("[UNSOUND]");
        }

		Gson gson = new Gson();
		String json = gson.toJson(sam);
		System.out.println("Config work:" + Config.workDirName);
		System.out.println("json--------------: " + json);
		String path = Config.workDirName;
		String[] arr = path.split("_");
		assert arr.length > 0 : "invalid path";
		String name = arr[arr.length - 1];
		if(name.contains(".")) {
			name = name.substring(0, name.indexOf('.'));
		}
		name += ".json";
		saveToFile(path + "/" + name, json);
    }

	public void saveToFile(String path, String content) {
		try {
			File file = new File(path);
			FileWriter fileWriter = new FileWriter(file);
			fileWriter.write(content);
			fileWriter.flush();
			fileWriter.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

}
