##################
# Malware signature(adrd)
##################
# name=malware-dlog

.include "Z.dom"
.include "M.dom"
.include "H.dom"
.include "L.dom"
.include "S.dom"
.include "CL.dom"
.include "COMP.dom"

.bddvarorder COMP0_CL0_COMP1_CL1_COMP2_S0_L0_Z0_M0_COMP3_L1_H0

ICCG(s:COMP,t:COMP)  input
SpecCallerComp(m:M,c:COMP)  input  #special call, e.g, does component c invoke abortBroadcast?
FlowComp(comp1:COMP, src:CL, comp2:COMP, sink:CL) input
Receiver(r:COMP) input
Service(r:COMP) input
Activity(r:COMP) input
InstallAPK(r:COMP) input
TgtDataType(r:COMP,h:H) input
CompIntentAction(c:COMP,act:S) input
Priority(c:COMP,p:Z) input

abortBroadcast(m:M) input
RuntimeExec(m:M) input
sendTextMsg(m:M) input

BootCompleted(act:S) input
SmsReceived(act:S) input
PickWifi(act:S) input
UmsConnected(act:S) input
ConnectChg(act:S) input
BatteryLow(act:S) input
PhoneState(act:S) input
SmsSent(act:S) input
NewOutCall(act:S) input
SigStr(act:S) input
PkgAdd(act:S) input
PkgChg(act:S) input
PkgRemove(act:S) input
PkgReplace(act:S) input
PkgInstall(act:S) input

AppSrcSink(d:L) input
DeviceId(d:L) input
SubId(e:L) input
EncSrc(e:L) input
EncSink(e:L) input
Internet(e:L) input
MODEL(e:L) input
BRAND(e:L) input
SDK(e:L) input
Manufact(e:L) input
Product(e:L) input
LineNumber(e:L) input
SmsContent(e:L) input
SimSerial(e:L) input
FileSrc(e:L) input
FileSink(e:L) input
WebView(e:L) input
Exec(e:L) input
InstallPackage(e:L) input

LCL(l:L,cl:CL) input

###################
#   OUTPUT 
###################
#NotDevNet(s:L, t:L) output
#For signature synthesis
SrcSinkComp(comp1:COMP, src:L, comp2:COMP, sink:L) output
BackEdge(s:COMP,t:COMP)  output
HasAPK(s:COMP) output

###################
#    RULES
###################
EncNet(src,sink) :- LCL(src,srccl), EncSrc(src), LCL(sink,sinkcl), Internet(sink), FlowComp(_,srccl,_,sinkcl).
NotEncNet(src,sink) :- !EncNet(src,sink).

SrcSinkComp(comp1,src,comp2,sink) :- FlowComp(comp1,srccl,comp2,sinkcl), LCL(src,srccl),AppSrcSink(src), LCL(sink,sinkcl), AppSrcSink(sink).
#t transitively launches s.
BackEdge(s,t) :- ICCG(t,s).
BackEdge(s,t) :- BackEdge(s,u), ICCG(t,u).
HasAPK(g) :- InstallAPK(g), ICCG(_,g).

